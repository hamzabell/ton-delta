// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String   @id @default(uuid())
  username       String?
  walletAddress  String?
  isFoundingMember Boolean @default(false)
  deposits       Deposit[]
  positions      Position[]
}

model Strategy {
  id             String   @id @default(uuid())
  ticker         String   // "DOGE"
  name           String   // "DOGE Crusher"
  type           String   // "FUNDING" or "BASIS"
  riskLevel      String   // "High", "Low"

  // Real-time Data
  currentApy     Float    // Updated every 8 hours
  tvl            Float    // Total Value Locked

  // Configuration
  fromAsset      String?  // swap.coffee "from" address (e.g. USDT)
  toAsset        String?  // swap.coffee "to" address (e.g. TON)
  cexSymbol      String?  // "DOGE/USDT:USDT"
  futureSymbol   String?  // "TON-USDT-24Q1" (for BASIS)
}

model Transaction {
  id             String   @id @default(uuid())
  strategyId     String
  type           String   // "SWAP", "SHORT", "REBALANCE"
  status         String   // "PENDING", "SUCCESS", "FAILED"
  txHash         String?
  fromAsset      String?
  toAsset        String?
  amount         Float?
  basisCaptured  Float?
  realizedPnl    Float?   @default(0) // Net Profit/Loss in USDT/TON
  feesPaid       Float?   @default(0) // Protocol + Gas fees
  timestamp      DateTime @default(now())
}

model Deposit {
  id        String   @id @default(uuid())
  amount    Float
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  timestamp DateTime @default(now())
}

model Position {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  pairId          String   // e.g. "dogs-ton"
  stasisPreference String @default("CASH") // "CASH" or "STAKE"
  
  // Vault Architecture
  vaultAddress    String   // The unique W5 Contract Address holding this position's funds
  tokenAddress    String?  // The address of the token (e.g. Jetton Master) for this pair
  
  capitalTON      Float?   // The intended investment amount (if specified by user)

  // Capital tracking
  spotAmount      Float    // Quantity of spot tokens
  perpAmount      Float    // Quantity of short contracts
  
  // Value tracking (Snapshot at last check)
  spotValue       Float    
  perpValue       Float
  totalEquity     Float    
  principalFloor  Float    // Stop-loss trigger level
  maxLossPercentage Float  @default(0.20) // Configurable Max Loss (default 20%)

  // Metrics
  entryPrice      Float
  currentPrice    Float
  fundingRate     Float
  driftCoefficient Float   // Delta imbalance
  
  // Delegation Details
  delegationExpiry DateTime? // When the session key expires (backend enforced)
  delegationDuration String? // Original duration selected (e.g. "7d")

  status          String   @default("active") // "active", "stasis", "closed", "processing_exit", "stasis_pending_stake", "stasis_active", "pending_entry"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastRebalanced  DateTime? // Timestamp of last rebalance action
  exitTxHash      String?   // Exit transaction hash for user reference
  entryTxHash     String?   // Master transaction hash from the Keeper for initial entry
  spotTxHash      String?   // Individual hash for spot purchase
  stormTxHash     String?   // Individual hash for storm trade
  
  fundingEvents   FundingEvent[]
}

model FundingEvent {
  id          String   @id @default(uuid())
  amount      Float    // Amount earned in USDT (or Base Asset)
  rate        Float    // Annualized Rate snapshot
  type        String   // "PAYMENT" or "DEDUCTION"
  timestamp   DateTime @default(now())
  
  positionId  String
  position    Position @relation(fields: [positionId], references: [id])
}



model JobRun {
  id             String    @id @default(uuid())
  workerName     String    // "strategy-job", "funding-monitor"
  startTime      DateTime  @default(now())
  endTime        DateTime?
  durationMs     Int?
  status         String    // "SUCCESS", "FAILURE"
  errorStack     String?   // If failed
  itemsProcessed Int?
}

model MetricSnapshot {
  id               String   @id @default(uuid())
  timestamp        DateTime @default(now())
  totalTvl         Float
  blendedApy       Float
  activeStrategies Int
  activePositions  Int
}

model AuditLog {
  id         String   @id @default(uuid())
  timestamp  DateTime @default(now())
  level      String   // "INFO", "WARN", "ERROR"
  component  String   // e.g., "ExecutionService", "API", "Worker"
  action     String   // e.g., "POSITION_CREATED", "PANIC_UNWIND_EXECUTED"
  positionId String?  // Optional reference to position
  details    String?  @db.Text // JSON string for additional context
  
  @@index([timestamp])
  @@index([level])
  @@index([component])
  @@index([positionId])
}

model Job {
  id            String    @id @default(uuid())
  name          String    // Job type: 'drift-monitor', 'safety-check', etc.
  payload       Json?     @db.JsonB // Job data as JSON
  status        String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  priority      Int       @default(0)
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3)
  error         String?   @db.Text
  
  // Scheduling
  scheduledFor  DateTime  @default(now())
  processedAt   DateTime?
  completedAt   DateTime?
  
  // Recurring jobs
  recurring     Boolean   @default(false)
  cronPattern   String?   // Cron pattern for recurring jobs
  lastRun       DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([status, scheduledFor])
  @@index([name, status])
}

model PriceHistory {
  id        String   @id @default(uuid())
  ticker    String   // 'TON', 'DOGE', etc.
  price     Float
  timestamp DateTime @default(now())
  
  @@index([ticker, timestamp])
  @@index([timestamp]) // For cleanup queries
}
